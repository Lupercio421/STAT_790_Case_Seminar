---
title: "dynamic regression attempt"
author: "Daniel L."
date: "5/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, results='hide', error=FALSE, include=FALSE}
library(tidyverse)
library(lubridate)
library(RSocrata)
library(tsfknn)
library(fpp3)
library(tsibble)
library(tseries)
library(feasts)
library(timetk)
library(modeltime)
library(readr)
library(zoo)
load("C:\\Users\\Daniel\\Desktop\\R\\STAT_790\\STAT_790_Case_Seminar\\dyna_regress_prep.Rdata")
```

# Auto-fit model

https://otexts.com/fpp3/regarima.html

The function ARIMA() will fit a regression model with ARIMA errors if exogenous regressors are included in the formula.

```{r}
auto_fit <- nyc_ts_2 %>% 
  model(ARIMA(tw_diff1 ~ cpi_diff1 + unemp_diff1 + avg_precip_diff1 + temp_diff1 + cdd_diff1))

report(auto_fit)
```

The model returns

## Auto-fit model with constant

```{r}
auto_fit_constant <- nyc_ts_2 %>% 
  model(ARIMA(tw_diff1 ~ 1 + cpi_diff1 + unemp_diff1 + avg_precip_diff1 + temp_diff1 + cdd_diff1))

report(auto_fit_constant)
```

Investigating a good ARIMA model for the total waste values

```{r}
nyc_ts_2 %>% 
  group_by("Year" = year(month)) %>% 
  summarise(.,
            "Average Total Waste" = mean(total_waste_total))
```

#### KPSS Test for 'total_waste' 
\
$H_0: \text{The time series is trend stationary}$ vs $H_a: \text{The time series is not trend stationary}$

If the p-value of the test is less than some significance level (e.g. $\alpha = .05$) then we reject the null hypothesis and conclude that the time series is not trend stationary.

```{r kpss test}
#total waste values
nyc_ts_2 %>% features(total_waste_total, unitroot_kpss)

#differenced values
nyc_ts_2 %>% features(tw_diff1, unitroot_kpss)
```

According to the results of the KPSS test, we reject the $H_0$ when evaluating the total_waste values. We fail to reject the $H_0$ when evaluating the differenced values

```{r}
nyc_ts_2 %>% 
  ACF(total_waste_total, lag_max = 36) %>% 
  autoplot()

#acf of the differenced values
nyc_ts_2 %>% 
  ACF(tw_diff1, lag_max = 36) %>% 
  autoplot()
```

# Creating ARIMA models with zoo() and the arima package from stats()

```{r}
DSNY_NYC_zoo_ts <- ts(final_nyc_data_small[,2],
   start = as.yearmon(final_nyc_data_small$month)[1],
   frequency = 12)

autoplot(as.zoo(DSNY_NYC_zoo_ts))
```


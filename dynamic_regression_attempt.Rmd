---
title: "Dynamic Regression"
author: "Daniel L."
date: "5/8/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, results='hide', error=FALSE, include=FALSE}
library(tidyverse)
library(lubridate)
library(RSocrata)
library(tsfknn)
library(fpp3)
library(tsibble)
library(tseries)
library(feasts)
library(timetk)
library(modeltime)
library(readr)
library(zoo)
load("C:\\Users\\Daniel\\Desktop\\R\\STAT_790\\STAT_790_Case_Seminar\\NYC_waste_tonnage.Rdata")
load("C:\\Users\\Daniel\\Desktop\\R\\STAT_790\\STAT_790_Case_Seminar\\external_datasets\\weather_data.Rdata")
```

```{r}
#inner_join(DSNY_NYC, weather_data)
```

# CPI Data and Unemployment Data

```{r CPI}
load("C:\\Users\\Daniel\\Desktop\\R\\STAT_790\\STAT_790_Case_Seminar\\external_datasets\\economic_variables.Rdata")
```
 
# Filter Weather Data: Jan '05 - Dec '20

```{r}
nyc_weather_data <- weather_data %>% 
  filter(date >= '2005-01-01' & date <= '2020-12-01') %>% 
  rename(month = 1)
```

# Joining all the datasets

```{r}
# Joining weather and cpi data
weather_cpi_data <- inner_join(nyc_weather_data, nys_cpi_final, by = 'month')

# Joining weather/cpi data and unemployment rate
weather_cpi_unemp <- inner_join(weather_cpi_data, nyc_unemployment_rate_final, by = 'month')

#final join
final_nyc_data <- inner_join(DSNY_NYC, weather_cpi_unemp, by = 'month') 

final_nyc_data <- final_nyc_data %>%
  mutate(month_num = seq.int(nrow(DSNY_NYC)))
```

# Final Dataset
```{r}
final_nyc_data< - final_nyc_datafinal_nyc_data %>% 
  select(1, c(9:14))
```

# Dynamic Regression

When we estimate the parameters from the model, we need to minimize the sum of squared $\epsilon_t$ values.

An important consideration when estimating a regression with ARMA errors is that all of the variables in the model must first be stationary. Thus, we first have to check that $y_t$ and all of the predictors appear to be stationary. If we estimate the model when any of these are non-stationary, the estimated coefficients will not be consistent estimates (and therefore may not be meaningful). 

```{r}
final_nyc_data %>% ggplot(., mapping = aes(x = month, y = total_waste_total)) + geom_line() +
  geom_point(color="steelblue")
final_nyc_data %>% ggplot(., mapping = aes(x = month, y = avg_precip)) + geom_line() +
  geom_point(color="steelblue")
final_nyc_data %>% ggplot(., mapping = aes(x = month, y = avg_temp)) + geom_line() +
  geom_point(color="steelblue")
final_nyc_data %>% ggplot(., mapping = aes(x = month, y = avg_CDD)) + geom_line() +
  geom_point(color="steelblue")
final_nyc_data %>% ggplot(., mapping = aes(x = month, y = cpi)) + geom_line() +
  geom_point(color="steelblue")
final_nyc_data %>% ggplot(., mapping = aes(x = month, y = unemp_rate)) + geom_line() +
  geom_point(color="steelblue")
```
```{r}
# ?across
# final_nyc_data %>% 
#   across(list(~scale(.) %>% 
#                 as.vector),
#          vars = c("total_waste_total", "unemp_rate"))
```

## Creation of tsibble

```{r smaller dataframe}
final_nyc_data_small <-final_nyc_data %>% 
  select(1, c(9:15))

#scaling the variables

```

```{r staionary check}
final_nyc_data_small %>% 
  mutate(tw_diff1 = difference(total_waste_total, 
                               differences = 1, 
                               order_by = month_num)) %>% 
  ggplot(., 
         mapping = aes(x = month, 
                       y = tw_diff1)) + geom_line() +
  geom_point(color="steelblue")

final_nyc_data_small %>% 
  mutate(temp_diff1 = difference(avg_temp, 
                                 differences = 1, 
                                 order_by = month_num)) %>% 
  ggplot(., 
         mapping = aes(x = month, 
                       y = temp_diff1)) + geom_line() +
  geom_point(color="steelblue")

final_nyc_data_small %>% 
  mutate(cdd_diff1 = difference(avg_CDD, 
                                 differences = 1, 
                                 order_by = month_num)) %>% 
  ggplot(., 
         mapping = aes(x = month, 
                       y = cdd_diff1)) + geom_line() +
  geom_point(color="steelblue")
```

```{r}
final_nyc_data_small <- final_nyc_data_small%>% 
  mutate(tw_diff1 = difference(total_waste_total, 
                               differences = 1, 
                               order_by = month_num),
         temp_diff1 = difference(avg_temp, 
                                 differences = 1, 
                                 order_by = month_num),
         cdd_diff1 = difference(avg_CDD, 
                                 differences = 1, 
                                 order_by = month_num))
```

```{r}
nyc_ts_1 <- as_tsibble(final_nyc_data_small, index = 'month', regular = FALSE) %>% fill_gaps()
nyc_ts_2 <- as_tsibble(final_nyc_data_small, index = 'month_num', regular = TRUE) %>% fill_gaps()
```

```{r}
# nyc_unemployment_rate_final %>% model(ARIMA(total_waste_total ~ avg_precip))
```
# First attempt at a TSLM fit

https://otexts.com/fpp3/forecasting.html
https://otexts.com/fpp3/forecasting-regression.html

```{r}
fit_trends <- nyc_ts_2 %>%
  model(
    linear = TSLM(tw_diff1 ~ cpi + unemp_rate + avg_precip + temp_diff1 + cdd_diff1)
    #exponential = TSLM(log(tw_diff1) ~  cpi + unemp_rate + avg_precip + temp_diff1 + cdd_diff1)
  )


# nyc_ts_2 %>%
#   autoplot(nyc_ts_2) +
#   geom_line(data = fitted(fit_trends),
#             aes(y = .fitted, colour = .model)) +
#   autolayer(fit_trends, alpha = 0.5, level = 95) +
#   labs(y = "Tons",
#        title = "Blank")
```
A new_data() argument needs to be made. I don't know if I should include the actual 2021 data for all 5 variables.
```{r}
nyc_data_small_future <- new_data(nyc_ts_2,2) %>% 
  mutate(cpi = c(825.413,111),
         unemp_rate = 0.1333,
         avg_precip = 0.07,
         avg_temp = 34.8,
         avg_CDD = 0)

nyc_data_small_future_diff <- new_data(nyc_ts_2,2) %>% 
  mutate(cpi = 825.413,
         unemp_rate = 0.1333,
         avg_precip = 0.07,
         temp_diff1 = -4.4,
         cdd_diff1 = 0)

forecast(fit_trends, new_data = nyc_data_small_future) %>% 
  autoplot(total_waste_total) + labs(y = "Total Tonnage")
```

```{r}
nyc_ts_2 %>% autoplot(total_waste_total)
```

